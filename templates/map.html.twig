{% extends 'sidenav.html.twig' %}

{% block stylesheets %}
	{{ parent() }}
	<style>
      	#fd_body {
        	position: absolute;
    		top:0px;
		   	bottom: 0;
		    width: 100%;
    	}
    </style>
{% endblock %}

{% block sidenav_options %}
	{% if marked %}
		<p data-toggle="modal" data-target="#editModal">Cambia posizione</p>
		<p data-toggle="modal" data-target="#deleteModal">Elimina posizione</p>
	{% else %}
		<p data-toggle="modal" data-target="#addModal">Fissa posizione</p>
	{% endif %}
	<p onclick="profile()">Profilo</p>
	<p onclick="logout()" id="logout">Logout</p>
{% endblock %}

{% block modals %}
	<div class="modal fade" id="addModal" role="dialog">
	    <div class="modal-dialog">
	    
	      <!-- Modal content-->
		    <div class="modal-content">
		        <div class="modal-header">
		          	<button type="button" class="close" data-dismiss="modal">&times;</button>
		          	<h4 class="modal-title">Fissa posizione</h4>
		        </div>
		        <div class="modal-body">
		        	<p>Sei sicuro di voler impostare il marker corrente come tua posizione attuale?<p>
		        	<p>Ricorda! Anche gli altri utenti potranno vedere questa posizione</p>
		        </div>
		        <div class="modal-footer">
		          	<button type="button" class="btn btn-success" onclick="saveMarker()" data-dismiss="modal">Conferma</button>
		          	<button type="button" class="btn btn-danger" data-dismiss="modal">Annulla</button>
		        </div>
		    </div>
	    </div>
	</div>
	<div class="modal fade" id="editModal" role="dialog">
	    <div class="modal-dialog">
	    
	      <!-- Modal content-->
		    <div class="modal-content">
		        <div class="modal-header">
		          	<button type="button" class="close" data-dismiss="modal">&times;</button>
		          	<h4 class="modal-title">Sposta marker</h4>
		        </div>
		        <div class="modal-body">
		        	<p>Sei sicuro di voler spostare il tuo marker?<p>
		        </div>
		        <div class="modal-footer">
		          	<button type="button" class="btn btn-success" onclick="editMarker()" data-dismiss="modal">Conferma</button>
		          	<button type="button" class="btn btn-danger" data-dismiss="modal">Annulla</button>
		        </div>
		    </div>
	    </div>
	</div>
	<div class="modal fade" id="deleteModal" role="dialog">
	    <div class="modal-dialog">
	    
	      <!-- Modal content-->
		    <div class="modal-content">
		        <div class="modal-header">
		          	<button type="button" class="close" data-dismiss="modal">&times;</button>
		          	<h4 class="modal-title">Rimuovi marker</h4>
		        </div>
		        <div class="modal-body">
		        	<p>Sei sicuro di voler eliminare il tuo marker?<p>
		        </div>
		        <div class="modal-footer">
		          	<button type="button" class="btn btn-danger" onclick="deleteMarker()" data-dismiss="modal">Conferma</button>
		          	<button type="button" class="btn btn-success" data-dismiss="modal">Annulla</button>
		        </div>
		    </div>
	    </div>
	</div>
{% endblock %}

{% block javascripts %}
	<script>
		var previousMarker = null;
		var map = null;
		function logout() {
			document.location.href = "{{ path('logout') }}";
		}

		function profile() {
			document.location.href = "{{ path('profile') }}";
		}
		function initMap() {

        	map = new google.maps.Map(document.getElementById('fd_body'), {
          				zoom: 6,
          				center: {lat: 41.5325, lng: 12.2858 
          			}
          		}
          	);
			$.ajax({
                url:'{{ (path('get_all_markers')) }}',
                type: "GET",
                dataType: "json",
                async: true,
                success: function (data)
                {
                	var nickname = '{{ nickname }}';
                    data.forEach(function(elem) {
                    	var infowindow = new google.maps.InfoWindow({
				          	content: 
				          	'<div id="content">' +
							'<div id="siteNotice">' +
							'</div>' +
							'<h2 id="firstHeading" class="firstHeading"> ' + elem.nickname + '</h2>' +
							'<div id="bodyContent">' +
							'<p> ' + elem.description + ' </p>' +
							'</div>' +
							'</div>'
				        });
                    	var marker = new google.maps.Marker({
				          position: {lat: Number(elem.latitude), lng: Number(elem.longitude)},
				          map: map,
				        });
				        if(elem.nickname == nickname) {
				         	marker.setIcon('http://maps.google.com/mapfiles/ms/icons/green-dot.png')
				        } else {
				        	marker.setIcon('http://maps.google.com/mapfiles/ms/icons/purple-dot.png')

				        }
				        marker.addListener('click', function() {
				          infowindow.open(map, marker);
				        });
                    });
                }
            });


	        map.addListener('click', function(e) {
	          	placeMarkerAndPanTo(e.latLng, map);
	        });
      	}

	    function placeMarkerAndPanTo(latLng, map) {
	    	if (previousMarker)
        		previousMarker.setMap(null);
		    previousMarker = new google.maps.Marker({
	        	position: latLng,
	        	map: map
	      	});
			previousMarker.setIcon('http://maps.google.com/mapfiles/ms/icons/red-dot.png')
	        map.panTo(latLng);
	    }

	    function saveMarker() {
	    	$.ajax({
                url:'{{ (path('add_marker')) }}',
                type: "POST",
                dataType: "json",
                data: {
                	latitude: previousMarker.getPosition().lat(),
                	longitude: previousMarker.getPosition().lng()
                },
                async: true,
                success: function (data)
                {
                   location.reload();
                }
            });
	    }

	    function editMarker() {
	    	$.ajax({
                url:'{{ (path('edit_marker')) }}',
                type: "POST",
                dataType: "json",
                data: {
                	latitude: previousMarker.getPosition().lat(),
                	longitude: previousMarker.getPosition().lng()
                },
                async: true,
                success: function (data)
                {
                   location.reload();
                }
            });
        }

        function deleteMarker() {
	    	$.ajax({
                url:'{{ (path('delete_marker')) }}',
                type: "POST",
                dataType: "json",
                async: true,
                success: function (data)
                {
                   location.reload();
                }
            });
        }
    </script>
    <script async defer
   		src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAyEDy7B__fUUmJsMDaoLGUrClpCmbQPic&callback=initMap">
    </script>
{% endblock %}
